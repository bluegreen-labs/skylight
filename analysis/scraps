    ! In-place adjustments (UTTER LLM BULLSHIT, double ckeck everything)
    output%sun_azimuth = output%sun_azimuth + 360 * E + output%longitude
    output%sun_altitude = output%sun_azimuth - output%sun_illuminance

    ! Calculate celestial body parameters
    call altaz( &
          output%sun_altitude, &
          output%sun_azimuth, &
          output%sun_illuminance, &
          cos(latitude), &
          sin(latitude), &
          DR, &
          RD, &
          Z, &
          output%moon_azimuth &
        )

    ! Solar altitude calculation
    call refr(output%sun_altitude, DR, output%sun_altitude)

    ! Atmospheric calculations
    call atmos(output%sun_altitude, DR, M)

    ! Solar illuminance
    output%sun_illuminance = 133775 * M / input%sky_condition

    ! Calculate lunar parameters
    call moon( &
          D, &
          output%sun_azimuth, &
          CE, &
          SE, &
          RD, &
          DR, &
          output%moon_azimuth, &
          output%moon_altitude, &
          output%moon_illuminance, &
          output%moon_fraction &
        )

    ! Lunar altazimuth
    call altaz( &
          output%moon_altitude, &
          output%moon_azimuth, &
          output%moon_illuminance, &
          cos(latitude), &
          sin(latitude), &
          DR, &
          RD, &
          Z, &
          output%moon_azimuth &
        )

    ! Lunar altitude
    call refr( &
          output%moon_altitude, &
          DR, &
          output%moon_altitude &
        )

    ! Atmospheric conditions
    call atmos( &
          output%moon_altitude, &
          DR, &
          M &
        )

    ! Lunar illuminance
    output%moon_illuminance = P * M / input%sky_condition


---- model

